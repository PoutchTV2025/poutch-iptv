<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poutch IPTV</title>
  <link href="https://unpkg.com/video.js/dist/video-js.css" rel="stylesheet">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5534/5534418.png" type="image/png">
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
    }
    .toggle-mode {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f2a900;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    #controls {
      text-align: center;
      padding: 10px;
    }
    #filters {
      margin: 10px auto;
      text-align: center;
    }
    select {
      padding: 5px;
      margin: 0 5px;
    }
    #player-container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }
    video {
      width: 100%;
      height: 80vh;
    }
    #channel-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px;
    }
    .channel {
      background: #222;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .channel:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <h1>Poutch IPTV</h1>
  <button class="toggle-mode" onclick="toggleTheme()">🎥 Mode clair/sombre</button>
  <div id="controls">
    <div id="filters">
      <label for="categoryFilter">Catégorie :</label>
      <select id="categoryFilter" onchange="loadByCategory()">
        <option value="news">News</option>
        <option value="movies">Movies</option>
        <option value="sports">Sports</option>
        <option value="music">Music</option>
        <option value="kids">Kids</option>
        <option value="religious">Religious</option>
        <option value="entertainment">Entertainment</option>
        <option value="documentary">Documentary</option>
        <option value="legislative">Legislative</option>
      </select>
      <label for="langFilter">Langue :</label>
      <select id="langFilter" onchange="renderChannels()">
        <option value="">Toutes</option>
      </select>
      <label><input type="checkbox" id="favoritesOnly" onchange="toggleFavoritesOnly()"> Favoris uniquement</label>
    </div>
  </div>
  <div id="player-container">
    <video id="iptvPlayer" class="video-js vjs-default-skin" controls autoplay></video>
    <div id="channel-list"></div>
  </div>
  <script src="https://unpkg.com/video.js/dist/video.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const player = videojs('iptvPlayer');
    let allChannels = [];
    let showOnlyFavorites = false;
    let favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

    function toggleTheme() {
      const body = document.body;
      if (body.style.backgroundColor === 'white') {
        body.style.backgroundColor = '#000';
        body.style.color = '#fff';
      } else {
        body.style.backgroundColor = 'white';
        body.style.color = '#000';
      }
    }

    function toggleFavoritesOnly() {
      showOnlyFavorites = document.getElementById("favoritesOnly").checked;
      renderChannels();
    }

    function renderChannels() {
      const list = document.getElementById("channel-list");
      list.innerHTML = '';
      const selectedLang = document.getElementById("langFilter").value;
      const filtered = allChannels.filter(c =>
        (!showOnlyFavorites || favorites.has(c.name)) &&
        (!selectedLang || c.language === selectedLang)
      );
      filtered.forEach(channel => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.textContent = channel.name + (favorites.has(channel.name) ? ' ⭐' : '');
        div.onclick = () => loadStream(channel.url);
        list.appendChild(div);
      });
    }

    function loadStream(url) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player.tech().el_);
        player.play();
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src({ type: 'application/x-mpegURL', src: url });
        player.play();
      } else {
        alert("Votre navigateur ne supporte pas la lecture HLS.");
      }
    }

    async function loadByCategory() {
      const category = document.getElementById("categoryFilter").value;
      const playlistUrl = `https://iptv-org.github.io/iptv/categories/${category}.m3u`;

      try {
        const response = await fetch(playlistUrl);
        const text = await response.text();
        const lines = text.split('\n');
        allChannels = [];
        const langs = new Set();

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#EXTINF')) {
            const nameMatch = lines[i].match(/,(.*)/);
            const name = nameMatch ? nameMatch[1].trim() : 'Chaîne';
            const langMatch = lines[i].match(/tvg-language="(.*?)"/i);
            const language = langMatch ? langMatch[1].toUpperCase() : '';
            langs.add(language);
            const streamUrl = lines[i + 1];
            if (streamUrl && streamUrl.startsWith('http')) {
              allChannels.push({ name, url: streamUrl, language });
            }
          }
        }

        const langFilter = document.getElementById("langFilter");
        langFilter.innerHTML = '<option value="">Toutes</option>';
        langs.forEach(lang => {
          const opt = document.createElement("option");
          opt.value = lang;
          opt.textContent = lang;
          langFilter.appendChild(opt);
        });

        if (allChannels.length > 0) {
          renderChannels();
          loadStream(allChannels[0].url);
        } else {
          throw new Error('Playlist vide');
        }
      } catch (e) {
        allChannels = [{
          name: "Chaîne Test - MUX",
          url: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8",
          language: "EN"
        }];
        renderChannels();
        loadStream(allChannels[0].url);
      }
    }

    window.onload = loadByCategory;
  </script>
</body>
</html>
